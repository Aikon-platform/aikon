{"version":3,"file":"pairProcessor.worker-0ee6dc1e.js","sources":["../src/constants.js","../src/documentSet/pairProcessor.worker.js"],"sourcesContent":["export const appLang = APP_LANG;\nexport const appName = APP_NAME;\nexport const webappName = WEBAPP_NAME;\nexport const userId = USER_ID;\nexport const isSuperuser = IS_SUPERUSER;\nexport const addPermission = ADD_PERMISSION;\nexport const csrfToken = CSRF_TOKEN;\nexport const modules = ADDITIONAL_MODULES;\nexport const regionsType = \"Region\";\nexport const appUrl = APP_URL;\nexport const sasUrl = SAS_APP_URL;\nexport const cantaloupeUrl = CANTALOUPE_APP_URL;\nexport const mediaPrefix = MEDIA_PATH;\nexport const pageSize = PAGE_LEN;\n\nexport const model2title = {\n    \"Witness\": appLang === \"en\"  ? \"Witness\" : \"Témoin\",\n    \"Work\": appLang === \"en\"  ? \"Work\" : \"Œuvre\",\n    \"Series\": appLang === \"en\"  ? \"Series\" : \"Série d'imprimés\",\n    \"Regions\": appLang === \"en\"  ? \"Region Extraction\" : \"Extraction d'illustrations\",\n}\n","import { regionsType } from \"../constants.js\";\n\nconst IMG_REGEX = /^(.+)_(\\d+)_([\\d,]+)\\.jpg$/;\n\nself.onmessage = (e) => {\n    const { rawPairs, selectedCategories } = e.data;\n    const results = processPairs(rawPairs);\n    self.postMessage(results);\n};\n\nfunction processPairs(data) {\n    const pairs = [];\n    const imageMap = new Map(); // imgId -> imgNode\n\n    const index = {\n        byImage: new Map(),   // imgId -> [pairs]\n        byDocPair: new Map(), // \"r1-r2\" -> [pairs]\n        byDoc: new Map(),     // rid -> [pairs]\n    };\n\n    const pStats = createStatsObject();\n    const docStats = createStatsObject();\n    const imgStats = createStatsObject();\n    const docPStats = createStatsObject();\n\n    const weights = {1: 1.0, 2: 0.5, 3: 0.125, 4: -1.0, 5: 0.125};\n\n    const len = data.length;\n    for (let i = 0; i < len; i++) {\n        const p = data[i];\n\n        if (p.category === 4) continue;\n\n        const w = weights[p.category] || 0;\n        const baseScore = p.score ?? w;\n        const weightedScore = Math.max(0.01, baseScore + baseScore * w);\n\n        const img1 = getOrAddImage(p.img_1, p.regions_id_1, imageMap, imgStats, docStats, weightedScore);\n        const img2 = getOrAddImage(p.img_2, p.regions_id_2, imageMap, imgStats, docStats, weightedScore);\n\n        const processedPair = {\n            id_1: img1.id,\n            id_2: img2.id,\n            regions_id_1: p.regions_id_1,\n            regions_id_2: p.regions_id_2,\n            page_1: img1.canvas,\n            page_2: img2.canvas,\n\n            score: p.score,\n            weightedScore: weightedScore,\n            category: p.category,\n            is_manual: p.is_manual,\n\n            // Rank for topk filtering\n            rank_1: 0,\n            rank_2: 0\n        };\n\n        pairs.push(processedPair);\n\n        updateStats(pStats, null, weightedScore);\n\n        const pairKey = p.regions_id_1 < p.regions_id_2\n            ? `${p.regions_id_1}-${p.regions_id_2}`\n            : `${p.regions_id_2}-${p.regions_id_1}`;\n\n        pushToMap(index.byDocPair, pairKey, processedPair);\n        updateStats(docPStats, pairKey, weightedScore);\n\n        pushToMap(index.byImage, img1.id, processedPair);\n        pushToMap(index.byImage, img2.id, processedPair);\n\n        pushToMap(index.byDoc, p.regions_id_1, processedPair);\n        pushToMap(index.byDoc, p.regions_id_2, processedPair);\n    }\n\n    pairs.sort((a, b) => b.weightedScore - a.weightedScore);\n\n    // TOP-K\n    for (const [imgId, imgPairs] of index.byImage) {\n        // Sort image pairs by descending score\n        imgPairs.sort((a, b) => b.weightedScore - a.weightedScore);\n\n        for (let k = 0; k < imgPairs.length; k++) {\n            const pair = imgPairs[k];\n            if (pair.id_1 === imgId) {\n                pair.rank_1 = k + 1; // Rang 1-based\n            } else {\n                pair.rank_2 = k + 1;\n            }\n        }\n    }\n\n    finalizeStats(pStats, pairs.length);\n    finalizeStats(docStats, docStats.scoreCount.size);\n    finalizeStats(imgStats, imgStats.scoreCount.size);\n    finalizeStats(docPStats, docPStats.scoreCount.size);\n\n    computeDensity(docStats);\n    computeDensity(imgStats);\n    computeDensity(docPStats);\n\n    return {\n        allPairs: pairs,\n        imageNodes: imageMap,\n        pairIndex: index,\n        stats: {\n            pairStats: pStats,\n            documentStats: docStats,\n            imageStats: imgStats,\n            docPairStats: docPStats\n        }\n    };\n}\n\nfunction getOrAddImage(imgKey, rid, map, imgStats, docStats, score) {\n    const imgId = `${rid}_${imgKey}`;\n    let imgData = map.get(imgId);\n\n    if (!imgData) {\n        let page = 0;\n        let ref = imgKey;\n        let coords = null; // string \"x,y,w,h\"\n\n        const match = imgKey.match(IMG_REGEX);\n        if (match) {\n            ref = `${match[1]}_${match[2]}.jpg`;\n            page = parseInt(match[2], 10);\n            coords = match[3];\n        } else {\n            const parts = imgKey.split('_');\n            if (parts.length >= 2) {\n                page = parseInt(parts[parts.length - 2], 10) || 0;\n            }\n        }\n\n        imgData = {\n            id: imgId,\n            regionId: rid,\n            ref: ref,\n            canvas: page,\n            xywh: coords ? coords.split(',') : null,\n            type: regionsType,\n            // to be initialized in the main thread\n            color: null\n        };\n        map.set(imgId, imgData);\n    }\n\n    updateStats(imgStats, imgId, score);\n    updateStats(docStats, rid, score);\n\n    return imgData;\n}\n\nfunction pushToMap(map, key, value) {\n    if (!map.has(key)) map.set(key, []);\n    map.get(key).push(value);\n}\n\nfunction createStatsObject() {\n    return {\n        count: 0,\n        totalScore: 0,\n        scoreCount: new Map(), // key -> { score, count }\n        scoreRange: { min: Infinity, max: -Infinity, range: 0 },\n        countRange: { min: Infinity, max: -Infinity, range: 0 },\n        links: 0,\n        density: 0\n    };\n}\n\nfunction updateStats(stats, key, score) {\n    if (key === null) {\n        stats.count++;\n        stats.totalScore += score;\n        updateMinMax(stats.scoreRange, score);\n        return;\n    }\n\n    let entry = stats.scoreCount.get(key);\n    if (!entry) {\n        entry = { score: 0, count: 0 };\n        stats.scoreCount.set(key, entry);\n        stats.count++; // Number of unique keys\n    }\n\n    entry.score += score;\n    entry.count += 1;\n}\n\nfunction updateMinMax(rangeObj, val) {\n    if (val < rangeObj.min) rangeObj.min = val;\n    if (val > rangeObj.max) rangeObj.max = val;\n}\n\nfunction finalizeStats(stats, linkCount) {\n    stats.links = linkCount;\n    stats.avgScore = stats.count > 0 ? stats.totalScore / stats.count : 0;\n\n    if (stats.scoreCount.size > 0) {\n        for (const val of stats.scoreCount.values()) {\n            updateMinMax(stats.scoreRange, val.score);\n            updateMinMax(stats.countRange, val.count);\n        }\n    } else if (stats.scoreRange.min === Infinity) {\n        stats.scoreRange.min = 0;\n        stats.scoreRange.max = 0;\n        stats.countRange.min = 0;\n        stats.countRange.max = 0;\n    }\n\n    stats.scoreRange.range = stats.scoreRange.max - stats.scoreRange.min;\n    stats.countRange.range = stats.countRange.max - stats.countRange.min;\n}\n\nfunction computeDensity(stats) {\n    if (stats.count <= 1) {\n        stats.density = 0;\n        return;\n    }\n    // Undirected graph density 2 * E / (V * (V-1))\n    stats.density = (2 * stats.links) / (stats.count * (stats.count - 1));\n}\n"],"names":["regionsType","IMG_REGEX","e","rawPairs","selectedCategories","results","processPairs","data","pairs","imageMap","index","pStats","createStatsObject","docStats","imgStats","docPStats","weights","len","i","p","w","baseScore","weightedScore","img1","getOrAddImage","img2","processedPair","updateStats","pairKey","pushToMap","b","imgId","imgPairs","a","k","pair","finalizeStats","computeDensity","imgKey","rid","map","score","imgData","page","ref","coords","match","parts","key","value","stats","updateMinMax","entry","rangeObj","val","linkCount"],"mappings":"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"}
