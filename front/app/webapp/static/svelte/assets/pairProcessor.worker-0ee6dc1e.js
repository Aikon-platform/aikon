(function(){"use strict";APP_LANG,APP_NAME,WEBAPP_NAME,USER_ID,IS_SUPERUSER,ADD_PERMISSION,CSRF_TOKEN,ADDITIONAL_MODULES;const E="Region";APP_URL,SAS_APP_URL,CANTALOUPE_APP_URL,MEDIA_PATH,PAGE_LEN;const D=/^(.+)_(\d+)_([\d,]+)\.jpg$/;self.onmessage=n=>{const{rawPairs:o,selectedCategories:c}=n.data,i=x(o);self.postMessage(i)};function x(n){const o=[],c=new Map,i={byImage:new Map,byDocPair:new Map,byDoc:new Map},l=p(),s=p(),r=p(),g=p(),f={1:1,2:.5,3:.125,4:-1,5:.125},R=n.length;for(let a=0;a<R;a++){const e=n[a];if(e.category===4)continue;const t=f[e.category]||0,_=e.score??t,m=Math.max(.01,_+_*t),y=M(e.img_1,e.regions_id_1,c,r,s,m),A=M(e.img_2,e.regions_id_2,c,r,s,m),u={id_1:y.id,id_2:A.id,regions_id_1:e.regions_id_1,regions_id_2:e.regions_id_2,page_1:y.canvas,page_2:A.canvas,score:e.score,weightedScore:m,category:e.category,is_manual:e.is_manual,rank_1:0,rank_2:0};o.push(u),S(l,null,m);const w=e.regions_id_1<e.regions_id_2?`${e.regions_id_1}-${e.regions_id_2}`:`${e.regions_id_2}-${e.regions_id_1}`;d(i.byDocPair,w,u),S(g,w,m),d(i.byImage,y.id,u),d(i.byImage,A.id,u),d(i.byDoc,e.regions_id_1,u),d(i.byDoc,e.regions_id_2,u)}o.sort((a,e)=>e.weightedScore-a.weightedScore);for(const[a,e]of i.byImage){e.sort((t,_)=>_.weightedScore-t.weightedScore);for(let t=0;t<e.length;t++){const _=e[t];_.id_1===a?_.rank_1=t+1:_.rank_2=t+1}}return P(l,o.length),P(s,s.scoreCount.size),P(r,r.scoreCount.size),P(g,g.scoreCount.size),h(s),h(r),h(g),{allPairs:o,imageNodes:c,pairIndex:i,stats:{pairStats:l,documentStats:s,imageStats:r,docPairStats:g}}}function M(n,o,c,i,l,s){const r=`${o}_${n}`;let g=c.get(r);if(!g){let f=0,R=n,a=null;const e=n.match(D);if(e)R=`${e[1]}_${e[2]}.jpg`,f=parseInt(e[2],10),a=e[3];else{const t=n.split("_");t.length>=2&&(f=parseInt(t[t.length-2],10)||0)}g={id:r,regionId:o,ref:R,canvas:f,xywh:a?a.split(","):null,type:E,color:null},c.set(r,g)}return S(i,r,s),S(l,o,s),g}function d(n,o,c){n.has(o)||n.set(o,[]),n.get(o).push(c)}function p(){return{count:0,totalScore:0,scoreCount:new Map,scoreRange:{min:1/0,max:-1/0,range:0},countRange:{min:1/0,max:-1/0,range:0},links:0,density:0}}function S(n,o,c){if(o===null){n.count++,n.totalScore+=c,I(n.scoreRange,c);return}let i=n.scoreCount.get(o);i||(i={score:0,count:0},n.scoreCount.set(o,i),n.count++),i.score+=c,i.count+=1}function I(n,o){o<n.min&&(n.min=o),o>n.max&&(n.max=o)}function P(n,o){if(n.links=o,n.avgScore=n.count>0?n.totalScore/n.count:0,n.scoreCount.size>0)for(const c of n.scoreCount.values())I(n.scoreRange,c.score),I(n.countRange,c.count);else n.scoreRange.min===1/0&&(n.scoreRange.min=0,n.scoreRange.max=0,n.countRange.min=0,n.countRange.max=0);n.scoreRange.range=n.scoreRange.max-n.scoreRange.min,n.countRange.range=n.countRange.max-n.countRange.min}function h(n){if(n.count<=1){n.density=0;return}n.density=2*n.links/(n.count*(n.count-1))}})();
//# sourceMappingURL=pairProcessor.worker-0ee6dc1e.js.map
